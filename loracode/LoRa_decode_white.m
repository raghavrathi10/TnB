% # LoRaMatlab
% LoRa Modulation and Coding Scheme Simulator on Matlab
% # Cite as
% Please cite the code which is part of our accepted publication:
% 
% B. Al Homssi, K. Dakic, S. Maselli, H. Wolf, S. Kandeepan, and A. Al-Hourani, "IoT Network Design using Open-Source LoRa Coverage Emulator," in IEEE Access. 2021.
% 
% Link on IEEE:
% https://ieeexplore.ieee.org/document/9395074
% 
% Link on researchgate:
% 
% https://www.researchgate.net/publication/350581481_IoT_Network_Design_using_Open-Source_LoRa_Coverage_Emulator

function [symbols_white] = LoRa_decode_white(symbols,CR,DE)
% LoRa_decode_white dewhitening of payload packet
%
%   in:  symbols       whitened symbols
%        CR            code rate
%        DE            data rate optimization flag
%
%  out:  symbols_white  dewhitened symbols

if DE == 0
    if CR > 2 && CR <= 4
        white_sequence = [255,255,45,255,120,255,225,255,0,255,210,45,85, ...
            120,75,225,102,0,30,210,255,85,45,75,120,102,225,30,210,255, ...
            135,45,204,120,170,225,180,210,153,135,225,204,0,170,0,180,0, ...
            153,0,225,210,0,85,0,153,0,225,0,210,210,135,85,30,153,45,225, ...
            120,210,225,135,210,30,85,45,153,120,51,225,85,210,75,85,102, ...
            153,30,51,45,85,120,75,225,102,0,30,0,45,0,120,210,225,135,0, ...
            204,0,120,0,51,210,85,135,153,204,51,120,85,51,153,85,51,153, ...
            135,51,204,85,170,153,102,51,30,135,45,204,120,170,51,102,85, ...
            30,153,45,225,120,0,51,0,85,210,153,85,225,75,0,180,0,75,210, ...
            102,85,204,75,170,180,102,75,204,102,170,204,180,170,75,102, ...
            102,204,204,170,120,180,51,75,85,102,75,204,102,120,204,51, ...
            120,85,225,75,0,102,210,204,135,120,30,225,255,0,255,210,45, ...
            135,170,30,102,255,204,255,170,45,102,170,30,102,255,204,45, ...
            170,170,102,180,30,75,255,102,45,30,170,45,180,170,75,180,102, ...
            153,30,225,45,210,170,85,180,153,153,225,225,0,210,210,85,135, ...
            153,204,225,170,0,102,210,204,135,120,204,225,170,210,102,135, ...
            204,30,120,255,225,45,210,120,135,51,30,135,255,30,45,45,120, ...
            120,51,51,135,135,30,204,45,120,120,225,51,210,135,85,204,75, ...
            120,102,225,204,210,170,85,180,75,153,102,51,204,85,170,153, ...
            180,225,153,210,51,85,85,75,153,180,225,153,210,51,85,85,75, ...
            75,180,180,153,75,51,180,85,153,75,51,180,135,75,30,180,45, ...
            153,170,51,102,199,30,30,45,45,170,170,102,102,204,30,120, ...
            45,51,170,135,102,30,204,255,120,45,51,170,135,102,30,30,255, ...
            255,45,255,170,255,102,45,30,170,255,180,255,153,255,51,45,135, ...
            170,204,180,120,153,51,51,135,135,204,204,170,120,180,51,75,135, ...
            180,204,153,170,225,180,210,75,135,180,204,153,120,225,225,210,0, ...
            135,0,204,210,120,135,225,30,0,45,0,170,210,180,135,75,30,180, ...
            45,75,170,180,180,75,75,102,180,30,75,255,180,255,75,45,102,120, ...
            30,51,255,85,255,75,45,180,120,153,51,225,85,0,75,210,180,85,153, ...
            153,225,51,0,135,210,30,85,255,153,255,51,255,135,255,30,0,0,0,0, ...
            135,225,170,204] ;
    elseif CR > 0 && CR <= 2
        white_sequence = [255,255,45,255,120,255,48,46,0,46,18,60,20,40,10, ...
            48,54,0,30,18,46,20,60,10,40,54,48,30,18,46,6,60,12,40,58,48,36, ...
            18,24,6,48,12,0,58,0,36,0,24,0,48,18,0,20,0,24,0,48,0,18,18,6,20, ...
            30,24,60,48,40,18,48,6,18,30,20,60,24,40,34,48,20,18,10,20,54,24, ...
            30,34,60,20,40,10,48,54,0,30,0,60,0,40,18,48,6,0,12,0,40,0,34,18, ...
            20,6,24,12,34,40,20,34,24,20,34,24,6,34,12,20,58,24,54,34,30,6,60, ...
            12,40,58,34,54,20,30,24,60,48,40,0,34,0,20,18,24,20,48,10,0,36,0, ...
            10,18,54,20,12,10,58,36,54,10,12,54,58,12,36,58,10,54,54,12,12,58, ...
            40,36,34,10,20,54,10,12,54,40,12,34,40,20,48,10,0,54,18,12,6,40,30, ...
            48,46,0,46,18,60,6,58,30,54,46,12,46,58,60,54,58,30,54,46,12,60,58, ...
            58,54,36,30,10,46,54,60,30,58,60,36,58,10,36,54,24,30,48,60,18,58, ...
            20,36,24,24,48,48,0,18,18,20,6,24,12,48,58,0,54,18,12,6,40,12,48, ...
            58,18,54,6,12,30,40,46,48,60,18,40,6,34,30,6,46,30,60,60,40,40,34, ...
            34,6,6,30,12,60,40,40,48,34,18,6,20,12,10,40,54,48,12,18,58,20,36, ...
            10,24,54,34,12,20,58,24,36,48,24,18,34,20,20,10,24,36,48,24,18,34, ...
            20,20,10,10,36,36,24,10,34,36,20,24,10,34,36,6,10,30,36,60,24,58, ...
            34,54,6,30,30,60,60,58,58,54,54,12,30,40,60,34,58,6,54,30,12,46, ...
            40,60,34,58,6,54,30,30,46,46,60,46,58,46,54,60,30,58,46,36,46,24, ...
            46,34,60,6,58,12,36,40,24,34,34,6,6,12,12,58,40,36,34,10,6,36,12, ...
            24,58,48,36,18,10,6,36,12,24,40,48,48,18,0,6,0,12,18,40,6,48,30,0, ...
            60,0,58,18,36,6,10,30,36,60,10,58,36,36,10,10,54,36,30,10,46,36,46, ...
            10,60,54,40,30,34,46,20,46,10,60,36,40,24,34,48,20,0,10,18,36,20,24, ...
            24,48,34,0,6,18,30,20,46,24,46,34,46,6,46,30,0,0,0,0,36,6] ;
    end
end
N = min([length(symbols) length(white_sequence)]) ; % LoRa symbol length
symbols_white = bitxor(symbols(1:N),white_sequence(1:N)) ;
end
